@page
@model DoQuangThang_SE1885_A01_FE.Pages.Reports.IndexModel
@{
    ViewData["Title"] = "Reports";
}

<div class="container-fluid py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h3 mb-0">📊 System Reporting</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a asp-page="/Index">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Reports</li>
            </ol>
        </nav>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <!-- SEARCH / FILTER FORM (GET) -->
            <form method="get" class="row g-3 align-items-end">
                <div class="col-sm-5 col-md-4">
                    <label asp-for="FromDate" class="form-label small text-muted">From</label>
                    <input asp-for="FromDate" type="date" class="form-control form-control-sm" />
                </div>
                <div class="col-sm-5 col-md-4">
                    <label asp-for="ToDate" class="form-label small text-muted">To</label>
                    <input asp-for="ToDate" type="date" class="form-control form-control-sm" />
                </div>
                <div class="col-sm-2 col-md-2 d-grid">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-filter me-1"></i> Apply
                    </button>
                </div>
            </form>

            <!-- EXPORT BUTTONS: MUST NOT BE NESTED INSIDE ANOTHER <form> -->
            <div class="row mt-2">
                <div class="col-12 col-md-6 offset-md-6 d-flex justify-content-md-end gap-2">
                    @* <form method="post" asp-page-handler="Export" class="d-flex gap-2 align-items-center">
                        <input type="hidden" name="fromDate" value="@(Model.FromDate?.ToString("yyyy-MM-dd") ?? "")" />
                        <input type="hidden" name="toDate" value="@(Model.ToDate?.ToString("yyyy-MM-dd") ?? "")" />

                        <div class="btn-group btn-group-sm" role="group" aria-label="CSV exports">
                            <button type="submit" name="reportType" value="ByCategory" class="btn btn-outline-secondary" title="Export By Category (CSV)">
                                <i class="bi bi-file-earmark-text"></i> CSV Category
                            </button>
                            <button type="submit" name="reportType" value="ByAuthor" class="btn btn-outline-secondary" title="Export By Author (CSV)">
                                <i class="bi bi-file-earmark-text"></i> CSV Author
                            </button>
                            <button type="submit" name="reportType" value="ByStatus" class="btn btn-outline-secondary" title="Export By Status (CSV)">
                                <i class="bi bi-file-earmark-text"></i> CSV Status
                            </button>
                            <button type="submit" name="reportType" value="Summary" class="btn btn-outline-success" title="Export Summary (CSV)">
                                <i class="bi bi-download"></i> CSV Summary
                            </button>
                        </div>
                    </form> *@

                    <form method="post" asp-page-handler="ExportXlsx" class="d-flex gap-2 align-items-center">
                        <input type="hidden" name="fromDate" value="@(Model.FromDate?.ToString("yyyy-MM-dd") ?? "")" />
                        <input type="hidden" name="toDate" value="@(Model.ToDate?.ToString("yyyy-MM-dd") ?? "")" />

                        <div class="btn-group btn-group-sm" role="group" aria-label="XLSX exports">
                            <button type="submit" name="reportType" value="ByCategory" class="btn btn-outline-primary" title="Export By Category (XLSX)">
                                <i class="bi bi-file-earmark-spreadsheet"></i> XLSX Category
                            </button>
                            <button type="submit" name="reportType" value="ByAuthor" class="btn btn-outline-primary" title="Export By Author (XLSX)">
                                <i class="bi bi-file-earmark-spreadsheet"></i> XLSX Author
                            </button>
                            <button type="submit" name="reportType" value="ByStatus" class="btn btn-outline-primary" title="Export By Status (XLSX)">
                                <i class="bi bi-file-earmark-spreadsheet"></i> XLSX Status
                            </button>
                            <button type="submit" name="reportType" value="Summary" class="btn btn-success" title="Export Summary (XLSX)">
                                <i class="bi bi-download"></i> XLSX Summary
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary cards with IDs for update -->
    <div class="row g-3 mb-4">
        <div class="col-sm-6 col-xl-4">
            <div class="card text-white bg-primary h-100 shadow-sm">
                <div class="card-body d-flex align-items-center">
                    <div class="me-3 display-6">
                        <i class="bi bi-article"></i>
                    </div>
                    <div>
                        <div class="small text-uppercase opacity-75">Total Articles</div>
                        <div class="h5 mb-0">@Model.Summary.TotalCount</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-sm-6 col-xl-4">
            <div class="card text-white bg-success h-100 shadow-sm">
                <div class="card-body d-flex align-items-center">
                    <div class="me-3 display-6">
                        <i class="bi bi-check2-circle"></i>
                    </div>
                    <div>
                        <div class="small text-uppercase opacity-75">Active Articles</div>
                        <div class="h5 mb-0">@Model.Summary.ActiveCount</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-sm-6 col-xl-4">
            <div class="card text-white bg-danger h-100 shadow-sm">
                <div class="card-body d-flex align-items-center">
                    <div class="me-3 display-6">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <div>
                        <div class="small text-uppercase opacity-75">Inactive Articles</div>
                        <div class="h5 mb-0">@Model.Summary.InactiveCount</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports grid -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <div class="fw-bold">📂 By Category</div>
                    <small class="text-white-50">Group counts per category</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Category ID</th>
                                    <th class="text-end">Total</th>
                                    <th class="text-end">Active</th>
                                    <th class="text-end">Inactive</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.ReportByCategory)
                                {
                                    <tr>
                                        <td>@item.CategoryId</td>
                                        <td class="text-end">@item.TotalCount</td>
                                        <td class="text-end">@item.ActiveCount</td>
                                        <td class="text-end">@item.InactiveCount</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <div class="fw-bold">✍️ By Author</div>
                    <small class="text-white-50">Group counts per author</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Author ID</th>
                                    <th class="text-end">Total</th>
                                    <th class="text-end">Active</th>
                                    <th class="text-end">Inactive</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.ReportByAuthor)
                                {
                                    <tr>
                                        <td>
                                            @if (item.CreatedById.HasValue)
                                            {
                                                <span class="fw-bold">@item.CreatedById</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted fst-italic">Unknown</span>
                                            }
                                        </td>
                                        <td class="text-end">@item.TotalCount</td>
                                        <td class="text-end">@item.ActiveCount</td>
                                        <td class="text-end">@item.InactiveCount</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <div class="fw-bold">🚦 By Status</div>
                    <small class="text-white-50">Active vs Inactive counts</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Status</th>
                                    <th class="text-end">Article Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.ReportByStatus)
                                {
                                    <tr>
                                        <td>
                                            @if (item.NewsStatus == true)
                                            {
                                                <span class="badge bg-success">Active</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Inactive</span>
                                            }
                                        </td>
                                        <td class="text-end fw-bold">@item.TotalCount</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        (function () {
            // Create connection to ReportHub
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/reportHub")
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Warning)
                .build();

            // When server notifies of changes, reload the page so reports refresh
            connection.on("ReportsUpdated", () => {
                console.info("ReportsUpdated received - reloading page to refresh reports.");
                location.reload();
            });

            connection.on("ReportsDeleted", () => {
                console.info("ReportsDeleted received - reloading page to refresh reports.");
                location.reload();
            });

            // Start connection with simple reconnect retry
            async function start() {
                try {
                    await connection.start();
                    console.info("Connected to /reportHub");
                } catch (err) {
                    console.warn("SignalR connection failed, retrying in 5s", err);
                    setTimeout(start, 5000);
                }
            }

            start();
        })();
    </script>
}