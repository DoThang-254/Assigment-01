@page
@model DoQuangThang_SE1885_A01_FE.Pages.Auth.IndexModel
@{
    ViewData["Title"] = "Account Management";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Accounts List</h2>
    <button class="btn btn-success" onclick="openSaveModal(0, '', '', 0)">
        <i class="bi bi-plus-circle"></i> Create New
    </button>
</div>

<form method="get" class="mb-3">
    <div class="row g-2 align-items-end" style="max-width:600px">
        <div class="col-md-5">
            <input type="text" name="keyword" value="@Model.Keyword" class="form-control" placeholder="Search name, email or role..." />
        </div>
        <div class="col-md-4">
            <select name="role" class="form-select">
                <option value="">-- All Roles --</option>
                <option value="1" selected="@(Model.Role == 1)">Staff</option>
                <option value="2" selected="@(Model.Role == 2)">Lecturer</option>
            </select>
        </div>
        <div class="col-md-3 d-flex gap-2">
            <button class="btn btn-primary" type="submit">Search</button>
            <a asp-page="/Auth/Index" class="btn btn-secondary">Clear</a>
        </div>
    </div>
</form>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<table class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>Id</th>
            <th>Email</th>
            <th>Name</th>
            <th>Role</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.Accounts != null && Model.Accounts.Any())
        {
            @foreach (var item in Model.Accounts)
            {
                <tr>
                    <td>@item.AccountId</td>
                    <td>@item.AccountEmail</td>
                    <td>@item.AccountName</td>
                    <td>
                        @(item.AccountRole switch
                        {
                            1 => "Staff",
                            2 => "Lecturer",
                            3 => "Admin",
                            _ => "Unknown"
                        })
            </td>
            <td>
                @* SỬA 1: Chỉ hiện nút nếu không phải Admin hệ thống (ID != 0) *@
                @if (item.AccountId != 0)
                        {
                            <button class="btn btn-sm btn-warning"
                                    onclick="openSaveModal(@item.AccountId, '@item.AccountName', '@item.AccountEmail', @item.AccountRole)">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger"
                                    onclick="openDeleteModal(@item.AccountId, '@item.AccountName')">
                                Delete
                            </button>
                        }
                        else
                        {
                            <span class="badge bg-secondary">System Admin</span>
                        }
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="5" class="text-center text-muted">Nothing to display</td>
            </tr>
        }
    </tbody>
</table>

@if (Model.TotalCount > Model.PageSize)
{
    int totalPages = (int)Math.Ceiling((double)Model.TotalCount / Model.PageSize);
    <nav>
        <ul class="pagination">
            @for (int i = 1; i <= totalPages; i++)
            {
                <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                    <a class="page-link" asp-page="./Index" asp-route-PageIndex="@i" asp-route-keyword="@Model.Keyword" asp-route-role="@Model.Role">@i</a>
                </li>
            }
        </ul>
    </nav>
}

<div class="modal fade" id="saveModal" tabindex="-1" aria-labelledby="saveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="SaveAccount">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveModalLabel">Account Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" asp-for="AccountInput.AccountId" id="modalAccountId" />

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" asp-for="AccountInput.AccountEmail" id="modalAccountEmail" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" asp-for="AccountInput.AccountName" id="modalAccountName" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" asp-for="AccountInput.AccountRole" id="modalAccountRole" required>
                            <option value="1">Staff</option>
                            <option value="2">Lecturer</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" id="lblPassword">Password</label>
                        <input type="password" class="form-control" asp-for="AccountInput.AccountPassword" id="modalPassword" placeholder="Enter password..." />
                        <small class="text-muted" id="passwordHint" style="display:none;">Leave blank to keep current password.</small>
                    </div>

                    <div class="mb-3" id="adminAuthContainer" style="display:none; background-color: #fff3cd; padding: 10px; border-radius: 5px; border: 1px dashed #ffc107;">
                        <label class="form-label text-danger fw-bold">Admin Confirmation Required</label>
                        <input type="password" class="form-control" asp-for="AccountInput.AdminVerifyPassword" id="modalAdminPassword" placeholder="Enter YOUR admin password (123)" />
                        <small class="text-danger">You must verify your identity to change user's password.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="DeleteAccount">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="AccountId" id="deleteAccountId" />
                    <p>Are you sure you want to delete account: <strong id="deleteAccountName"></strong>?</p>
                    <p class="text-danger"><small>This action cannot be undone.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // SỬA 3: Đặt Script đúng chỗ và Logic chính xác
        function openSaveModal(id, name, email, role) {
            // 1. Gán giá trị cơ bản
            document.getElementById('modalAccountId').value = id;
            document.getElementById('modalAccountName').value = name;
            document.getElementById('modalAccountEmail').value = email;
            document.getElementById('modalAccountRole').value = role || 1;

            // 2. Reset các ô password
            var passwordInput = document.getElementById('modalPassword');
            var adminPassInput = document.getElementById('modalAdminPassword');
            var adminAuthContainer = document.getElementById('adminAuthContainer');

            passwordInput.value = '';
            adminPassInput.value = '';

            // 3. Xử lý hiển thị Create vs Update
            var modalTitle = document.getElementById('saveModalLabel');
            var passwordHint = document.getElementById('passwordHint');
            var lblPassword = document.getElementById('lblPassword');

            if (id === 0) {
                // === CREATE MODE ===
                modalTitle.innerText = "Create New Account";

                // Email: Được sửa
                document.getElementById('modalAccountEmail').readOnly = false;

                // Password: Bắt buộc
                passwordInput.required = true;
                lblPassword.innerText = "Password (Required)";
                passwordHint.style.display = 'none';

                // Admin Verify: Ẩn (Tạo mới không cần xác thực Admin Pass)
                adminAuthContainer.style.display = 'none';
                adminPassInput.required = false;

                // Reset sự kiện để tránh lỗi
                passwordInput.oninput = null;
            } else {
                // === UPDATE MODE ===
                modalTitle.innerText = "Update Account";

                // Email: Không được sửa
                document.getElementById('modalAccountEmail').readOnly = true;

                // Password: Tùy chọn
                passwordInput.required = false;
                lblPassword.innerText = "New Password (Optional)";
                passwordHint.style.display = 'block';

                // Admin Verify: Mặc định ẩn
                adminAuthContainer.style.display = 'none';
                adminPassInput.required = false;

                // LOGIC: Chỉ hiện ô verify khi gõ vào ô New Password
                passwordInput.oninput = function() {
                    if (this.value.trim().length > 0) {
                        adminAuthContainer.style.display = 'block';
                        adminPassInput.required = true; // Bắt buộc nhập pass admin để xác nhận
                    } else {
                        adminAuthContainer.style.display = 'none';
                        adminPassInput.required = false;
                    }
                };
            }

            var myModal = new bootstrap.Modal(document.getElementById('saveModal'));
            myModal.show();
        }

        function openDeleteModal(id, name) {
            document.getElementById('deleteAccountId').value = id;
            document.getElementById('deleteAccountName').innerText = name;
            var myModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            myModal.show();
        }
    </script>
}