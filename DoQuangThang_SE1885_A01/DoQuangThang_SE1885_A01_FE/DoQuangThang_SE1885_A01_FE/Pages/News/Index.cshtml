@page
@model DoQuangThang_SE1885_A01_FE.Pages.News.IndexModel
@{
    ViewData["Title"] = "News Management";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary"><i class="bi bi-newspaper"></i> News Management</h2>
    <button class="btn btn-success"
            onclick="openSaveModal('0', '', '', '', '', '', true, 1, '')">
        <i class="bi bi-plus-lg"></i> Create News
    </button>
</div>

<div class="card card-body bg-light mb-4">
    <form method="get">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label fw-bold">Keyword</label>
                <input type="text" name="Keyword" value="@Model.Keyword" class="form-control" placeholder="Title, Author, Category..." />
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">Status</label>
                <select name="Status" class="form-select">
                    <option value="">-- All --</option>
                    <option value="true" selected="@(Model.Status == "true")">Active</option>
                    <option value="false" selected="@(Model.Status == "false")">Inactive</option>
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label fw-bold">Created Date Range</label>
                <div class="input-group">
                    <span class="input-group-text">From</span>
                    <input type="date" name="StartDate" value="@(Model.StartDate?.ToString("yyyy-MM-dd"))" class="form-control" />
                    <span class="input-group-text">To</span>
                    <input type="date" name="EndDate" value="@(Model.EndDate?.ToString("yyyy-MM-dd"))" class="form-control" />
                </div>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Filter</button>
            </div>
            <div class="col-12 text-end">
                <a asp-page="./Index" class="text-decoration-none small">Clear Filters</a>
            </div>
        </div>
    </form>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<table class="table table-bordered table-hover shadow-sm">
    <thead class="table-primary">
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Category</th>
            <th>Author</th>
            <th>Created Date</th>
            <th>Status</th>
            <th>Actions</th>
            <th>Tags</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.NewsList != null && Model.NewsList.Any())
        {
            @foreach (var item in Model.NewsList)
            {
                <tr>
                    <td>@item.NewsArticleId</td>
                    <td title="@item.NewsTitle">
                        <span class="fw-bold">@item.NewsTitle</span>
                        <div class="small text-muted text-truncate" style="max-width: 250px;">
                            @item.NewsContent
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-info text-dark">
                            @(item.Category?.CategoryName ?? "No Category")
                        </span>
                    </td>
                    <td>@(item.CreatedBy?.AccountName ?? "Unknown")</td>
                    <td>@(item.CreatedDate?.ToString("dd/MM/yyyy HH:mm"))</td>
                    <td>
                        @if (item.NewsStatus == true)
                        {
                            <span class="badge bg-success">Active</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactive</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning"
                                onclick="openSaveModal(
                    '@item.NewsArticleId',
                    '@(System.Web.HttpUtility.JavaScriptStringEncode(item.NewsTitle))',
                    '@(System.Web.HttpUtility.JavaScriptStringEncode(item.Headline))',
                    '@(System.Web.HttpUtility.JavaScriptStringEncode(item.NewsContent))',
                    '@(System.Web.HttpUtility.JavaScriptStringEncode(item.NewsSource))',
                    '@item.CategoryId',
                    @(item.NewsStatus == true ? "true" : "false"),
                    1,
                    '@(item.Tags != null ? string.Join(",", item.Tags.Select(t => t.TagId)) : "")'
                )">
                            Update
                        </button>

                        <button class="btn btn-sm btn-info text-white"
                                title="Duplicate this article"
                                onclick="openSaveModal(
                '0',  /* QUAN TRỌNG: ID = 0 để báo hiệu tạo mới */
                '@(System.Web.HttpUtility.JavaScriptStringEncode(item.NewsTitle))', /* Copy Title */
                '@(System.Web.HttpUtility.JavaScriptStringEncode(item.Headline))',
                '@(System.Web.HttpUtility.JavaScriptStringEncode(item.NewsContent))',
                '@(System.Web.HttpUtility.JavaScriptStringEncode(item.NewsSource))',
                '@item.CategoryId',
                @(item.NewsStatus == true ? "true" : "false"),
                1,
                '@(item.Tags != null ? string.Join(",", item.Tags.Select(t => t.TagId)) : "")'
            )">
                            <i class="bi bi-files"></i> Copy
                        </button>

                        <button class="btn btn-sm btn-danger"
                                onclick="openDeleteModal('@item.NewsArticleId', '@(System.Web.HttpUtility.JavaScriptStringEncode(item.NewsTitle))')">
                            Remove
                        </button>
                    </td>
                    <td>
                        @if (item.Tags != null && item.Tags.Any())
                        {
                            @foreach (var tag in item.Tags)
                            {
                                <span class="badge bg-secondary me-1">@tag.TagName</span>
                            }
                        }
                        else
                        {
                            <span class="text-muted small">No Tags</span>
                        }
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="7" class="text-center text-muted py-4">No news articles found matching your criteria.</td>
            </tr>
        }
    </tbody>
</table>
@if (Model.TotalPages > 0)
{
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            @{
                var prevParms = new Dictionary<string, string>
                {
                { "CurrentPage", (Model.CurrentPage - 1).ToString() },
                { "Keyword", Model.Keyword },
                { "Status", Model.Status },
                { "StartDate", Model.StartDate?.ToString("yyyy-MM-dd") },
                { "EndDate", Model.EndDate?.ToString("yyyy-MM-dd") }
                };

                var nextParms = new Dictionary<string, string>
                {
                { "CurrentPage", (Model.CurrentPage + 1).ToString() },
                { "Keyword", Model.Keyword },
                { "Status", Model.Status },
                { "StartDate", Model.StartDate?.ToString("yyyy-MM-dd") },
                { "EndDate", Model.EndDate?.ToString("yyyy-MM-dd") }
                };
            }

            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link" asp-all-route-data="prevParms">Previous</a>
            </li>

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                var pageParms = new Dictionary<string, string>
                {
                { "CurrentPage", i.ToString() },
                { "Keyword", Model.Keyword },
                { "Status", Model.Status },
                { "StartDate", Model.StartDate?.ToString("yyyy-MM-dd") },
                { "EndDate", Model.EndDate?.ToString("yyyy-MM-dd") }
                };

                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                    <a class="page-link" asp-all-route-data="pageParms">@i</a>
                </li>
            }

            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                <a class="page-link" asp-all-route-data="nextParms">Next</a>
            </li>
        </ul>
    </nav>
}
else{
<div class="text-center text-muted">No pagination available.</div>
}

<div class="modal fade" id="saveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="Save">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="saveModalLabel">News Article</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="NewsArticleId" id="modalId" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">News Title</label>
                        <input type="text" name="NewsTitle" id="modalTitle" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Headline</label>
                        <input type="text" name="Headline" id="modalHeadline" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">News Source</label>
                        <input type="text" name="NewsSource" id="modalSource" class="form-control" required />
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Category</label>
                            <select name="CategoryId" id="modalCategory" class="form-select" required>
                                <option value="">-- Select Category --</option>
                                @foreach (var cat in Model.Categories)
                                {
                                    <option value="@cat.CategoryId">@cat.CategoryName</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tags</label>
                            <div class="card p-2" style="max-height: 150px; overflow-y: auto;">
                                @if (Model.AllTags.Any())
                                {
                                    @foreach (var tag in Model.AllTags)
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input tag-checkbox" type="checkbox"
                                                   name="TagIds"
                                                   value="@tag.TagId"
                                                   id="tag_@tag.TagId">
                                            <label class="form-check-label" for="tag_@tag.TagId">
                                                @tag.TagName
                                            </label>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="text-muted accept-policy">No tags available.</div> 
                                }
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Status</label>
                        <select name="NewsStatus" id="modalStatus" class="form-select">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Content</label>
                        <textarea name="NewsContent" id="modalContent" class="form-control" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="Delete">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="deleteId" />
                    <p>Are you sure you want to delete news: <strong id="deleteTitle" class="text-danger"></strong>?</p>
                    <small class="text-muted">This action usually cannot be undone.</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Confirm Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openSaveModal(id, title, headline, content,source , catId, status, authorId , currentTagIds) {
            // Reset form logic
            document.getElementById('modalId').value = id;
            document.getElementById('modalTitle').value = title;
            document.getElementById('modalContent').value = content;
            document.getElementById('modalHeadline').value = headline || '';
            document.getElementById('modalSource').value = source || '';

            var statusSelect = document.getElementById('modalStatus');
        if (status === true || status === 'true' || status === 'True') {
            statusSelect.value = 'true';
        } else {
            statusSelect.value = 'false';
        }

            // Set Select values
            var catSelect = document.getElementById('modalCategory');
            catSelect.value = catId;

                var checkboxes = document.querySelectorAll('.tag-checkbox');
        checkboxes.forEach(cb => cb.checked = false);

        // Bước 2b: Nếu có currentTagIds (dạng chuỗi "1,3,5"), thì check vào các ô tương ứng
        if (currentTagIds && currentTagIds.length > 0) {
            // Tách chuỗi thành mảng các ID
            var idsArray = currentTagIds.split(',');

            idsArray.forEach(tagId => {
                // Tìm checkbox có value == tagId và check nó
                var cb = document.querySelector(`.tag-checkbox[value="${tagId}"]`);
                if (cb) {
                    cb.checked = true;
                }
            });
        }

            // Title Modal
            // var modalTitle = document.getElementById('saveModalLabel');
            // if (id === '0' || id === '') {
            //     modalTitle.innerText = "Create News Article";
            //     document.getElementById('modalId').value = ''; 
            // } else {
            //     modalTitle.innerText = "Update News Article (ID: " + id + ")";
            // }

                    if (id === '0' || id === '') {
            // Sửa lại một chút để kiểm tra xem có nội dung (title) được truyền vào không
            if (title && title.length > 0) {
                 modalTitle.innerText = "Duplicate News Article"; // Nếu ID=0 mà có Title => Là Duplicate
            } else {
                 modalTitle.innerText = "Create News Article"; // Nếu ID=0 và không có Title => Là Create mới tinh
            }
            document.getElementById('modalId').value = '0'; // Đảm bảo set value là 0
        } else {
            modalTitle.innerText = "Update News Article (ID: " + id + ")";
        }

            var myModal = new bootstrap.Modal(document.getElementById('saveModal'));
            myModal.show();
        }

        function openDeleteModal(id, title) {
            document.getElementById('deleteId').value = id;
            document.getElementById('deleteTitle').innerText = title;
            var myModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            myModal.show();
        }
    </script>
}