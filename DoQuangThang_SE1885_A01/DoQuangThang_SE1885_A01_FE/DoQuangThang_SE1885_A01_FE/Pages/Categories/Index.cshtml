@page
@model DoQuangThang_SE1885_A01_FE.Pages.Categories.IndexModel
@{
    ViewData["Title"] = "Category Management";
}

<!-- Toast container -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index:1080;">
    <div id="toastContainer">
        @if (TempData["Success"] != null)
        {
            <div class="toast align-items-center text-white bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        @TempData["Success"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="toast align-items-center text-white bg-danger border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        @TempData["Error"]
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        }
    </div>
</div>

<!-- Global loading overlay -->
<div id="globalLoaderCategories" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="z-index:1090; background: rgba(255,255,255,0.6);">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <span class="ms-2 fw-semibold">Loading…</span>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><i class="bi bi-tags"></i> Category Management</h2>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createModal">
        <i class="bi bi-plus-lg me-1"></i> New Category
    </button>
</div>

<div class="card mb-3">
    <div class="card-body">
        <form method="get" id="categoryFilterForm" class="row g-2 align-items-end" data-show-loader="false">
            <div class="col-md-8">
                <label class="visually-hidden" for="SearchTerm">Search</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="SearchTerm" name="SearchTerm" value="@Model.SearchTerm" class="form-control" placeholder="Search by name or description" />
                </div>
            </div>
            <div class="col-md-4 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel"></i> Search</button>
                <a asp-page="./Index" class="btn btn-outline-secondary w-100">Clear</a>
            </div>
        </form>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <!-- fallback alert (for non-JS) -->
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<table class="table table-bordered table-hover align-middle">
    <thead class="table-light">
        <tr>
            <th>Name</th>
            <th>Description</th>
            <th style="width:8%;">Articles</th>
            <th style="width:10%;">Status</th>
            <th style="width:16%;">Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.Categories == null || !Model.Categories.Any())
        {
            <tr>
                <td colspan="5" class="text-center text-muted py-4">No categories found.</td>
            </tr>
        }
        else
        {
            @foreach (var c in Model.Categories)
            {
                <tr>
                    <td class="fw-semibold">@c.CategoryName</td>
                    <td class="text-break">@c.CategoryDesciption</td>
                    <td>@c.ArticleCount</td>
                    <td>
                        @if (c.IsActive == true)
                        {
                            <span class="badge bg-success">Active</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactive</span>
                        }
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" type="button" onclick="openEdit(@c.CategoryId)"><i class="bi bi-pencil"></i> Edit</button>
                            <button class="btn btn-sm btn-outline-danger" type="button" onclick="confirmDelete(@c.CategoryId)"><i class="bi bi-trash"></i> Delete</button>
                            <button class="btn btn-sm btn-outline-success" type="button" onclick="toggleActive(@c.CategoryId)"><i class="bi bi-toggle-on"></i> Toggle</button>
                        </div>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@if (Model.TotalPages > 0)
{
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            @{
                var prevParams = new Dictionary<string, string>
                {
                    { "CurrentPage", (Model.CurrentPage - 1).ToString() },
                    { "SearchTerm", Model.SearchTerm ?? string.Empty }
                };
                var nextParams = new Dictionary<string, string>
                {
                    { "CurrentPage", (Model.CurrentPage + 1).ToString() },
                    { "SearchTerm", Model.SearchTerm ?? string.Empty }
                };
            }
            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link show-loader-on-click" asp-all-route-data="prevParams">Previous</a>
            </li>

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                var pageParams = new Dictionary<string, string>
                {
                    { "CurrentPage", i.ToString() },
                    { "SearchTerm", Model.SearchTerm ?? string.Empty }
                };
                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                    <a class="page-link show-loader-on-click" asp-all-route-data="pageParams">@i</a>
                </li>
            }

            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                <a class="page-link show-loader-on-click" asp-all-route-data="nextParams">Next</a>
            </li>
        </ul>
    </nav>
}

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="Create" data-show-loader="true" class="needs-validation" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title" id="createModalLabel">Create Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input asp-for="Category.CategoryName" class="form-control" required />
                        <div class="invalid-feedback">Name is required.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        <input asp-for="Category.CategoryDescription" class="form-control" required />
                        <div class="invalid-feedback">Description is required.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parent Category</label>
                        <select asp-for="Category.ParentCategoryId" class="form-select">
                            <option value="">-- No Parent --</option>
                            @if (Model.Categories != null)
                            {
                                foreach (var cat in Model.Categories)
                                {
                                    <option value="@cat.CategoryId">@cat.CategoryName</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="Update" data-show-loader="true" class="needs-validation" novalidate>
                <input type="hidden" asp-for="UpdatedCategory.CategoryId" id="edit_CategoryId" />
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input asp-for="UpdatedCategory.CategoryName" required id="edit_CategoryName" class="form-control" />
                        <div class="invalid-feedback">Name is required.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        <input asp-for="UpdatedCategory.CategoryDesciption" required id="edit_CategoryDescription" class="form-control" />
                        <div class="invalid-feedback">Description is required.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Parent Category</label>
                        <select asp-for="UpdatedCategory.ParentCategoryId" id="edit_ParentCategoryId" class="form-select">
                            <option value="">-- No Parent --</option>
                            @if (Model.Categories != null)
                            {
                                foreach (var cat in Model.Categories)
                                {
                                    <option value="@cat.CategoryId">@cat.CategoryName</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select asp-for="UpdatedCategory.IsActive" id="edit_IsActive" class="form-select">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // show any server-rendered toasts
        (function () {
            var toasts = document.querySelectorAll('#toastContainer .toast');
            toasts.forEach(function (t) {
                try { new bootstrap.Toast(t, { delay: 5000 }).show(); } catch (e) { console.warn(e); }
            });
        })();

        // Loader helpers
        function showGlobalLoaderCategories() {
            document.getElementById('globalLoaderCategories')?.classList.remove('d-none');
        }
        function hideGlobalLoaderCategories() {
            document.getElementById('globalLoaderCategories')?.classList.add('d-none');
        }

        // Attach loader to forms that request it and to pagination links
        // Attach loader to forms that request it and to pagination links
         (function () {
             var forms = document.querySelectorAll('form[data-show-loader="true"]');
             forms.forEach(function (f) {
                 f.addEventListener('submit', function (event) {
                     // FIX: Check if the form is valid first
                     if (!f.checkValidity()) {
                         // If the form is invalid, the validation script (below) will handle it.
                         // We simply return here so we don't show the loader.
                         return;
                     }

                     showGlobalLoaderCategories();
                 });
             });

             var links = document.querySelectorAll('.show-loader-on-click');
             links.forEach(function (a) {
                 a.addEventListener('click', function () { showGlobalLoaderCategories(); });
             });

             window.addEventListener('pageshow', function () { hideGlobalLoaderCategories(); });
         })();

        // ===== EDIT logic (fetch API) =====
        function setVal(id, value) {
            const el = document.getElementById(id);
            if (el) el.value = (value === null || value === undefined) ? "" : value;
        }

        function openEdit(id) {
            showGlobalLoaderCategories();
            fetch(`https://localhost:7066/api/Category(${id})`)
                .then(r => {
                    if (!r.ok) throw new Error('Network response was not ok');
                    return r.json();
                })
                .then(c => {
                    setVal("edit_CategoryId", c.CategoryId);
                    setVal("edit_CategoryName", c.CategoryName);
                    setVal("edit_CategoryDescription", c.CategoryDescription ?? c.CategoryDesciption ?? "");
                    setVal("edit_ParentCategoryId", c.ParentCategoryId ?? "");
                    // ensure select receives "true"/"false" string
                    var isActive = (c.IsActive === true || c.IsActive === "true") ? "true" : "false";
                    setVal("edit_IsActive", isActive);
                    var editModal = new bootstrap.Modal(document.getElementById('editModal'));
                    editModal.show();
                })
                .catch(e => {
                    console.error(e);
                    alert('Failed to load category details.');
                })
                .finally(() => hideGlobalLoaderCategories());
        }

        // ===== DELETE =====
        function confirmDelete(id) {
            if (confirm("Are you sure you want to delete this category?")) {
                showGlobalLoaderCategories();
                // navigate to handler which will perform server-side delete and redirect
                window.location = "?handler=Delete&id=" + id;
            }
        }

        // ===== TOGGLE ACTIVE =====
        function toggleActive(id) {
            showGlobalLoaderCategories();
            fetch(`https://localhost:7066/api/Category(${id})`, { method: "PATCH" })
                .then(r => {
                    if (!r.ok) throw new Error('Toggle failed');
                    // reload to reflect changes
                    location.reload();
                })
                .catch(e => {
                    console.error(e);
                    alert('Failed to toggle active state.');
                    hideGlobalLoaderCategories();
                });
        }

        // client-side bootstrap validation for modal forms
        (function () {
            var validationForms = document.querySelectorAll('.needs-validation');
            validationForms.forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        })();

        // SignalR refresh
        (function () {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/reportHub")
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Warning)
                .build();

            connection.on("MetadataUpdated", (metaType) => {
                try {
                    const t = (metaType || "").toString().toLowerCase();
                    if (t === "category") location.reload();
                } catch (e) {
                    console.warn(e);
                    location.reload();
                }
            });

            async function start() {
                try {
                    await connection.start();
                } catch (err) {
                    setTimeout(start, 5000);
                }
            }

            start();
        })();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
}