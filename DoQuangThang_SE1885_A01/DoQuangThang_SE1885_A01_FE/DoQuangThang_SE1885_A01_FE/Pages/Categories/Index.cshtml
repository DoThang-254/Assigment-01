@page
@model DoQuangThang_SE1885_A01_FE.Pages.Categories.IndexModel
@{
}

<h2>Category Management</h2>

<form method="get" class="mb-2">
    <input name="SearchTerm" value="@Model.SearchTerm"
           placeholder="Search by name or description" />
    <button type="submit">Search</button>
    <button type="button" onclick="openCreate()">+ New</button>
</form>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">
        @TempData["Success"]
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        @TempData["Error"]
    </div>
}

<div asp-validation-summary="All" class="text-danger"></div>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Articles</th>
            <th>Active</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        @if(!Model.Categories.Any())
        {
            <tr>
                <td colspan="5" class="text-center">No categories found.</td>
            </tr>
        }
        @foreach (var c in Model.Categories)
        {
            <tr>
                <td>@c.CategoryName</td>
                <td>@c.CategoryDesciption</td>
                <td>@c.ArticleCount</td>
                <td>
                    <input type="checkbox"
                           @(c.IsActive == true ? "checked" : "")
                           onclick="toggleActive(@c.CategoryId)" />
                </td>
                <td>
                    <button type="button" onclick="openEdit(@c.CategoryId)">Edit</button>
                    <button type="button" onclick="confirmDelete(@c.CategoryId)">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@if (Model.TotalPages > 0)
{
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            @{
                // Tạo Dictionary tham số để giữ lại SearchTerm khi chuyển trang
                var prevParams = new Dictionary<string, string>
                {
                { "CurrentPage", (Model.CurrentPage - 1).ToString() },
                { "SearchTerm", Model.SearchTerm }
                };
                var nextParams = new Dictionary<string, string>
                {
                { "CurrentPage", (Model.CurrentPage + 1).ToString() },
                { "SearchTerm", Model.SearchTerm }
                };
            }

            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link" asp-all-route-data="prevParams">Previous</a>
            </li>

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                var pageParams = new Dictionary<string, string>
                {
                { "CurrentPage", i.ToString() },
                { "SearchTerm", Model.SearchTerm }
                };
                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                    <a class="page-link" asp-all-route-data="pageParams">@i</a>
                </li>
            }

            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                <a class="page-link" asp-all-route-data="nextParams">Next</a>
            </li>
        </ul>
    </nav>
}

<div id="createModal" class="modal-bg">
    <div class="modal-box">
        <h4>Create Category</h4>

        <form method="post" asp-page-handler="Create">
            <div>
                <label>Name *</label>
                <input asp-for="Category.CategoryName" required class="form-control" />
                <span asp-validation-for="Category.CategoryName" class="text-danger"></span>
            </div>

            <div>
                <label>Description *</label>
                <input asp-for="Category.CategoryDescription" required class="form-control" />
                <span asp-validation-for="Category.CategoryDescription" class="text-danger"></span>
            </div>

            <div class="mb-2">
                <label>Parent Category</label>
                <select asp-for="Category.ParentCategoryId" class="form-control">
                    <option value="">-- No Parent --</option>
                    @if (Model.Categories != null)
                    {
                        foreach (var cat in Model.Categories)
                        {
                            <option value="@cat.CategoryId">@cat.CategoryName</option>
                        }
                    }
                </select>
            </div>

            <div class="mt-2">
                <button type="submit" class="btn btn-success">Create</button>
                <button type="button" class="btn btn-secondary" onclick="closeCreate()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="editModal" class="modal-bg">
    <div class="modal-box">
        <h4>Edit Category</h4>
        
        <form method="post" asp-page-handler="Update">
            <input type="hidden" asp-for="UpdatedCategory.CategoryId" id="edit_CategoryId" />

            <div class="mb-2">
                <label>Name *</label>
                <input asp-for="UpdatedCategory.CategoryName" required id="edit_CategoryName" class="form-control" />
                <span asp-validation-for="UpdatedCategory.CategoryName" class="text-danger"></span>
            </div>

            <div class="mb-2">
                <label>Description *</label>
                <input asp-for="UpdatedCategory.CategoryDesciption" required id="edit_CategoryDescription" class="form-control" />
                <span asp-validation-for="UpdatedCategory.CategoryDesciption" class="text-danger"></span>
            </div>

            <div class="mb-2">
                <label>Parent Category</label>
                <select asp-for="UpdatedCategory.ParentCategoryId" id="edit_ParentCategoryId" class="form-control">
                    <option value="">-- No Parent --</option>
                    @if (Model.Categories != null)
                    {
                        foreach (var cat in Model.Categories)
                        {
                            <option value="@cat.CategoryId">@cat.CategoryName</option>
                        }
                    }
                </select>
            </div>

            <div class="mb-2">
                <label>Status</label>
                <select asp-for="UpdatedCategory.IsActive" id="edit_IsActive" class="form-control">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary">Update</button>
                <button type="button" class="btn btn-secondary" onclick="closeEdit()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
    .modal-bg {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.4);
    }

    .modal-box {
        width: 420px;
        background: #fff;
        padding: 20px;
        margin: 120px auto;
        border-radius: 6px;
    }
</style>

@section Scripts {
    <script>
                function setVal(id, value) {
            const el = document.getElementById(id);
            if (el) {
                // Nếu value là null/undefined thì gán rỗng, ngược lại gán giá trị
                el.value = (value === null || value === undefined) ? "" : value;
            }
        }

        // ===== CREATE =====
        function openCreate() {
            clearForm();
            document.getElementById("createModal").style.display = "block";
        }
        function closeCreate() {
            document.getElementById("createModal").style.display = "none";
        }

        // ===== EDIT =====
                  function openEdit(id) {
            fetch(`https://localhost:7066/api/Category(${id})`)
                .then(r => r.json())
                .then(c => {
                    console.log(c); // Debug xem dữ liệu trả về

                    // Gán dữ liệu cơ bản
                    setVal("edit_CategoryId", c.CategoryId);
                    setVal("edit_CategoryName", c.CategoryName);
                    setVal("edit_CategoryDescription", c.CategoryDescription); // Lưu ý chính tả Description

                    // 1. Xử lý Dropdown Parent
                    // Nếu null thì gán chuỗi rỗng để chọn option "-- No Parent --"
                    setVal("edit_ParentCategoryId", c.ParentCategoryId);

                    // 2. Xử lý Dropdown Status
                    // Chuyển boolean true/false thành chuỗi "true"/"false" để khớp với value của option
                    // Nếu API trả về IsActive (PascalCase) hay isActive (camelCase) thì chỉnh lại cho đúng biến c
                    let statusVal = (c.IsActive === true || c.IsActive === "true") ? "true" : "false";
                    setVal("edit_IsActive", statusVal);

                    document.getElementById("editModal").style.display = "block";
                })
                .catch(e => console.error(e));
        }

        function closeEdit() {
            document.getElementById("editModal").style.display = "none";
        }

        // ===== DELETE =====
        function confirmDelete(id) {
            if (confirm("Are you sure you want to delete this category?")) {
                window.location = "?handler=Delete&id=" + id;
            }
        }

        // ===== TOGGLE ACTIVE =====
        function toggleActive(id) {
            fetch(`https://localhost:7066/api/Category(${id})`, { method: "PATCH" })
                .then(() => location.reload());
        }

        // ===== HELPERS =====
        function clearForm() {
            setVal("Category_CategoryId", "");
            setVal("Category_CategoryName", "");
            setVal("Category_CategoryDesciption", "");
            setVal("Category_ParentCategoryId", "");
        }
    </script>
}